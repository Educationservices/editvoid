<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voidagon C</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.4/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #36393f;
            color: #dcddde;
            height: 100vh;
            overflow: hidden;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: #36393f;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 400px;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 30px;
            color: #ffffff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #b9bbbe;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: #40444b;
            border: none;
            border-radius: 4px;
            color: #dcddde;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            background: #484c52;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #5865f2;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #4752c4;
        }

        .btn-secondary {
            background: #4f545c;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5d6269;
        }

        /* Main App Layout */
        .app {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .app-header {
            background: #2f3136;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #202225;
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .notification-icon:hover {
            background: #40444b;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #ed4245;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .app-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #202225;
        }

        .sidebar-section {
            padding: 16px;
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            color: #8e9297;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .channel-list {
            list-style: none;
        }

        .channel-item {
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-item:hover {
            background: #40444b;
        }

        .channel-item.active {
            background: #5865f2;
        }

        .friend-list {
            flex: 1;
            overflow-y: auto;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .friend-item:hover {
            background: #40444b;
        }

        .friend-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 500;
        }

        .friend-status {
            font-size: 12px;
            color: #8e9297;
        }

        .status-online {
            color: #3ba55d !important;
        }

        .status-offline {
            color: #747f8d !important;
        }

        .friend-actions {
            display: flex;
            gap: 4px;
        }

        .friend-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-accept {
            background: #3ba55d;
            color: white;
        }

        .btn-decline {
            background: #ed4245;
            color: white;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #36393f;
            padding: 12px 20px;
            border-bottom: 1px solid #40444b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-icon {
            font-size: 20px;
            color: #8e9297;
        }

        .channel-name {
            font-weight: 600;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 16px;
            padding: 4px 0;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            color: #ffffff;
        }

        .message-timestamp {
            font-size: 12px;
            color: #8e9297;
        }

        .message-text {
            line-height: 1.375;
            word-wrap: break-word;
        }

        .typing-indicator {
            padding: 8px 16px;
            font-style: italic;
            color: #8e9297;
            font-size: 14px;
        }

        /* Chat Input */
        .chat-input-container {
            padding: 20px;
            background: #36393f;
        }

        .chat-input {
            width: 100%;
            padding: 12px 16px;
            background: #40444b;
            border: none;
            border-radius: 8px;
            color: #dcddde;
            font-size: 16px;
            resize: none;
            max-height: 200px;
        }

        .chat-input:focus {
            outline: none;
            background: #484c52;
        }

        .chat-input::placeholder {
            color: #8e9297;
        }

        /* Settings Screen */
        .settings-screen {
            display: none;
            background: #36393f;
            height: 100vh;
            overflow-y: auto;
        }

        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 40px;
        }

        .back-btn {
            background: #40444b;
            border: none;
            color: #dcddde;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #484c52;
        }

        .settings-title {
            font-size: 32px;
            font-weight: 600;
        }

        .settings-section {
            background: #2f3136;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #40444b;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-description {
            font-size: 14px;
            color: #8e9297;
            margin-top: 4px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #4f545c;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: #3ba55d;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            background: #2f3136;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .notification-header {
            padding: 16px;
            border-bottom: 1px solid #40444b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #40444b;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #40444b;
        }

        .notification-item.unread {
            background: #40444b;
            border-left: 3px solid #5865f2;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: #b9bbbe;
        }

        .notification-time {
            font-size: 12px;
            color: #8e9297;
            margin-top: 4px;
        }

        /* Friend Request Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: #36393f;
            padding: 24px;
            border-radius: 8px;
            width: 400px;
            max-width: 90vw;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-modal {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2f3136;
        }

        ::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #36393f;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
        }

        .error-message {
            color: #ed4245;
            font-size: 14px;
            margin-top: 8px;
        }

        .success-message {
            color: #3ba55d;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <h1 class="login-title">Voidagon C</h1>
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
                </div>
                <button class="btn" id="loginBtn">Sign In</button>
                <button class="btn btn-secondary" id="showRegisterBtn">Create Account</button>
                <div id="loginMessage"></div>
            </div>
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" class="form-input" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-input" placeholder="Choose a password">
                </div>
                <button class="btn" id="registerBtn">Create Account</button>
                <button class="btn btn-secondary" id="showLoginBtn">Back to Sign In</button>
                <div id="registerMessage"></div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="app">
        <div class="app-header">
            <div class="app-title">Voidagon C</div>
            <div class="user-info">
                <div class="notification-icon" id="notificationIcon">
                    🔔
                    <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
                </div>
                <div class="user-avatar" id="userAvatar"></div>
                <span id="currentUsername"></span>
                <button class="btn-secondary" id="settingsBtn" style="padding: 6px 12px; margin-left: 10px;">⚙️ Settings</button>
                <button class="btn-secondary" id="logoutBtn" style="padding: 6px 12px;">Logout</button>
            </div>
        </div>

        <div class="app-content">
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Text Channels</div>
                    <ul class="channel-list">
                        <li class="channel-item active" data-channel="general">
                            <span class="channel-icon">#</span>
                            <span>general</span>
                        </li>
                    </ul>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">
                        Friends
                        <button id="addFriendBtn" style="float: right; background: #5865f2; border: none; color: white; border-radius: 3px; padding: 2px 6px; cursor: pointer;">+</button>
                    </div>
                    <div class="friend-list" id="friendList">
                        <!-- Friends will be populated here -->
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="chat-header">
                    <span class="channel-icon">#</span>
                    <span class="channel-name" id="currentChannelName">general</span>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be populated here -->
                </div>

                <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>

                <div class="chat-input-container">
                    <textarea 
                        id="messageInput" 
                        class="chat-input" 
                        placeholder="Message #general"
                        rows="1"
                    ></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div class="settings-screen" id="settingsScreen">
        <div class="settings-container">
            <div class="settings-header">
                <button class="back-btn" id="backToAppBtn">← Back</button>
                <h1 class="settings-title">Settings</h1>
            </div>

            <div class="settings-section">
                <h2 class="settings-section-title">Appearance</h2>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Theme</div>
                        <div class="setting-description">Choose between light and dark themes</div>
                    </div>
                    <select id="themeSelect" style="background: #40444b; color: #dcddde; border: none; padding: 6px; border-radius: 4px;">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-section-title">Notifications</h2>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Enable Notifications</div>
                        <div class="setting-description">Show desktop notifications</div>
                    </div>
                    <div class="toggle-switch" id="notificationsToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Message Notifications</div>
                        <div class="setting-description">Get notified when someone sends a message</div>
                    </div>
                    <div class="toggle-switch active" id="messageNotificationsToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Friend Request Notifications</div>
                        <div class="setting-description">Get notified when someone sends you a friend request</div>
                    </div>
                    <div class="toggle-switch active" id="friendRequestNotificationsToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Sound Notifications</div>
                        <div class="setting-description">Play sounds for notifications</div>
                    </div>
                    <div class="toggle-switch active" id="soundNotificationsToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-section-title">Privacy & Safety</h2>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Failsafe Key</div>
                        <div class="setting-description">Keyboard shortcut to quickly navigate away</div>
                    </div>
                    <input type="text" id="failsafeKeyInput" style="background: #40444b; color: #dcddde; border: none; padding: 6px; border-radius: 4px;" value="ctrl+`">
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Failsafe URL</div>
                        <div class="setting-description">Website to navigate to when failsafe is triggered</div>
                    </div>
                    <input type="text" id="failsafeUrlInput" style="background: #40444b; color: #dcddde; border: none; padding: 6px; border-radius: 4px; width: 200px;" value="https://www.google.com">
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-section-title">Profile</h2>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Profile Picture</div>
                        <div class="setting-description">Upload a Base64 encoded image</div>
                    </div>
                    <textarea id="profilePictureInput" style="background: #40444b; color: #dcddde; border: none; padding: 6px; border-radius: 4px; width: 300px; height: 60px;" placeholder="Paste Base64 image data here..."></textarea>
                </div>
                <button class="btn" id="saveProfileBtn" style="margin-top: 10px;">Save Profile Picture</button>
            </div>

            <button class="btn" id="saveSettingsBtn">Save All Settings</button>
        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button id="markAllReadBtn" style="background: #5865f2; border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Mark All Read</button>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <h2 class="modal-title">Add Friend</h2>
            <div class="form-group">
                <label>Enter username:</label>
                <input type="text" id="friendUsernameInput" class="form-input" placeholder="Username">
            </div>
            <div class="modal-buttons">
                <button class="btn-modal" id="sendFriendRequestBtn" style="background: #3ba55d; color: white;">Send Request</button>
                <button class="btn-modal" id="cancelFriendRequestBtn" style="background: #4f545c; color: white;">Cancel</button>
            </div>
            <div id="friendRequestMessage"></div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let currentChannel = 'general';
        let typingTimeout;
        let isTyping = false;
        let notifications = [];
        let settings = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadFromStorage();
        });

        function initializeEventListeners() {
            // Login/Register
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('showRegisterBtn').addEventListener('click', showRegisterForm);
            document.getElementById('showLoginBtn').addEventListener('click', showLoginForm);
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Navigation
            document.getElementById('settingsBtn').addEventListener('click', showSettings);
            document.getElementById('backToAppBtn').addEventListener('click', showApp);

            // Chat
            document.getElementById('messageInput').addEventListener('keydown', handleMessageInput);
            document.getElementById('messageInput').addEventListener('input', handleTyping);

            // Friends
            document.getElementById('addFriendBtn').addEventListener('click', showAddFriendModal);
            document.getElementById('sendFriendRequestBtn').addEventListener('click', sendFriendRequest);
            document.getElementById('cancelFriendRequestBtn').addEventListener('click', hideAddFriendModal);

            // Notifications
            document.getElementById('notificationIcon').addEventListener('click', toggleNotificationPanel);
            document.getElementById('markAllReadBtn').addEventListener('click', markAllNotificationsRead);

            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfilePicture);

            // Toggle switches
            setupToggleSwitches();

            // Failsafe key
            document.addEventListener('keydown', handleFailsafeKey);

            // Close modals on click outside
            document.getElementById('addFriendModal').addEventListener('click', function(e) {
                if (e.target === this) hideAddFriendModal();
            });

            document.addEventListener('click', function(e) {
                if (!document.getElementById('notificationPanel').contains(e.target) && 
                    !document.getElementById('notificationIcon').contains(e.target)) {
                    hideNotificationPanel();
                }
            });
        }

        function setupToggleSwitches() {
            const toggles = document.querySelectorAll('.toggle-switch');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const messageEl = document.getElementById('loginMessage');

            if (!username || !password) {
                showMessage(messageEl, 'Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = {
                        username: data.username,
                        profile_picture: data.profile_picture
                    };
                    saveToStorage();
                    initializeApp();
                } else {
                    showMessage(messageEl, data.message, 'error');
                }
            } catch (error) {
                showMessage(messageEl, 'Connection error. Please try again.', 'error');
            }
        }

async function register() {
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;
    const messageEl = document.getElementById('registerMessage');

    if (!username || !password) {
        showMessage(messageEl, 'Please fill in all fields', 'error');
        return;
    }

    if (username.length < 3) {
        showMessage(messageEl, 'Username must be at least 3 characters long', 'error');
        return;
    }

    if (password.length < 6) {
        showMessage(messageEl, 'Password must be at least 6 characters long', 'error');
        return;
    }

    try {
        const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
            showMessage(messageEl, 'Account created successfully! Please sign in.', 'success');
            showLoginForm();
        } else {
            showMessage(messageEl, data.message, 'error');
        }
    } catch (error) {
        showMessage(messageEl, 'Connection error. Please try again.', 'error');
    }
}

function showMessage(element, message, type) {
    element.textContent = message;
    element.className = type === 'error' ? 'error-message' : 'success-message';
}

function initializeApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    
    // Initialize WebSocket connection
    initializeSocket();
    
    // Load user data
    loadUserData();
    
    // Load settings
    loadSettings();
    
    // Load initial data
    loadInitialData();
}

function initializeSocket() {
    // Connect to Socket.IO server
    socket = io();
    
    // Handle connection events
    socket.on('connect', () => {
        console.log('Connected to WebSocket server');
        socket.emit('user_online', { username: currentUser.username });
        socket.emit('join_channel', { username: currentUser.username, channel: currentChannel });
    });
    
    socket.on('disconnect', () => {
        console.log('Disconnected from WebSocket server');
    });
    
    // Handle incoming messages
    socket.on('new_message', (message) => {
        if (message.channel === currentChannel) {
            addMessageToChat(message);
        }
    });
    
    // Handle typing indicators
    socket.on('user_typing', (data) => {
        if (data.typing) {
            showTypingIndicator(data.username);
        } else {
            hideTypingIndicator();
        }
    });
    
    // Handle user status changes
    socket.on('user_status_changed', (data) => {
        updateFriendStatus(data.username, data.status);
    });
    
    // Handle new notifications
    socket.on('new_notification', (notification) => {
        addNotification(notification);
        showNotificationBadge();
    });
}

async function loadUserData() {
    document.getElementById('currentUsername').textContent = currentUser.username;
    
    // Set user avatar
    const avatarEl = document.getElementById('userAvatar');
    if (currentUser.profile_picture) {
        avatarEl.style.backgroundImage = `url(${currentUser.profile_picture})`;
        avatarEl.style.backgroundSize = 'cover';
    } else {
        avatarEl.textContent = currentUser.username.charAt(0).toUpperCase();
    }
}

async function loadSettings() {
    try {
        const response = await fetch(`/get_settings?username=${currentUser.username}`);
        const data = await response.json();
        
        if (data.success) {
            settings = data.settings;
            applySettings();
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

function applySettings() {
    // Apply theme
    if (settings.theme === 'light') {
        document.body.style.backgroundColor = '#ffffff';
        document.body.style.color = '#000000';
        document.getElementById('themeSelect').value = 'light';
    } else {
        document.body.style.backgroundColor = '#36393f';
        document.body.style.color = '#dcddde';
        document.getElementById('themeSelect').value = 'dark';
    }
    
    // Apply notification toggles
    document.getElementById('notificationsToggle').classList.toggle('active', settings.notifications);
    document.getElementById('messageNotificationsToggle').classList.toggle('active', settings.message_notifications);
    document.getElementById('friendRequestNotificationsToggle').classList.toggle('active', settings.friend_request_notifications);
    document.getElementById('soundNotificationsToggle').classList.toggle('active', settings.sound_notifications);
    
    // Apply failsafe settings
    document.getElementById('failsafeKeyInput').value = settings.failsafe_key || 'ctrl+`';
    document.getElementById('failsafeUrlInput').value = settings.failsafe_url || 'https://www.google.com';
}

async function loadInitialData() {
    // Load messages for current channel
    loadMessages();
    
    // Load friends list
    loadFriends();
    
    // Load notifications
    loadNotifications();
}

async function loadMessages() {
    try {
        const response = await fetch(`/get_messages?channel=${currentChannel}`);
        const data = await response.json();
        
        if (data.success) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            data.messages.forEach(message => {
                addMessageToChat(message);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

function addMessageToChat(message) {
    const chatMessages = document.getElementById('chatMessages');
    
    const messageElement = document.createElement('div');
    messageElement.className = 'message';
    
    const avatarElement = document.createElement('div');
    avatarElement.className = 'message-avatar';
    
    if (message.profile_picture) {
        avatarElement.style.backgroundImage = `url(${message.profile_picture})`;
        avatarElement.style.backgroundSize = 'cover';
    } else {
        avatarElement.textContent = message.username.charAt(0).toUpperCase();
    }
    
    const contentElement = document.createElement('div');
    contentElement.className = 'message-content';
    
    const headerElement = document.createElement('div');
    headerElement.className = 'message-header';
    
    const authorElement = document.createElement('span');
    authorElement.className = 'message-author';
    authorElement.textContent = message.username;
    
    const timestampElement = document.createElement('span');
    timestampElement.className = 'message-timestamp';
    timestampElement.textContent = new Date(message.timestamp).toLocaleTimeString();
    
    const textElement = document.createElement('div');
    textElement.className = 'message-text';
    textElement.textContent = message.message;
    
    headerElement.appendChild(authorElement);
    headerElement.appendChild(timestampElement);
    
    contentElement.appendChild(headerElement);
    contentElement.appendChild(textElement);
    
    messageElement.appendChild(avatarElement);
    messageElement.appendChild(contentElement);
    
    chatMessages.appendChild(messageElement);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function handleMessageInput(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    try {
        const response = await fetch('/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: currentUser.username,
                message: message,
                channel: currentChannel
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageInput.value = '';
            // Message will be added via WebSocket
        }
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

function handleTyping() {
    if (!isTyping) {
        isTyping = true;
        socket.emit('typing_start', {
            username: currentUser.username,
            channel: currentChannel
        });
    }
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        isTyping = false;
        socket.emit('typing_stop', {
            username: currentUser.username,
            channel: currentChannel
        });
    }, 2000);
}

function showTypingIndicator(username) {
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.textContent = `${username} is typing...`;
    typingIndicator.style.display = 'block';
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

async function loadFriends() {
    try {
        const response = await fetch(`/get_friends?username=${currentUser.username}`);
        const data = await response.json();
        
        if (data.success) {
            const friendList = document.getElementById('friendList');
            friendList.innerHTML = '';
            
            // Add pending received requests
            if (data.pending_received && data.pending_received.length > 0) {
                const pendingSection = document.createElement('div');
                pendingSection.className = 'sidebar-section';
                pendingSection.innerHTML = '<div class="sidebar-title">Pending Requests</div>';
                
                const pendingList = document.createElement('div');
                
                data.pending_received.forEach(friend => {
                    const friendItem = createFriendItem(friend, 'pending');
                    pendingList.appendChild(friendItem);
                });
                
                pendingSection.appendChild(pendingList);
                friendList.appendChild(pendingSection);
            }
            
            // Add friends
            if (data.friends && data.friends.length > 0) {
                const friendsSection = document.createElement('div');
                friendsSection.className = 'sidebar-section';
                friendsSection.innerHTML = '<div class="sidebar-title">Friends</div>';
                
                const friendsList = document.createElement('div');
                
                data.friends.forEach(friend => {
                    const friendItem = createFriendItem(friend, 'friend');
                    friendsList.appendChild(friendItem);
                });
                
                friendsSection.appendChild(friendsList);
                friendList.appendChild(friendsSection);
            }
        }
    } catch (error) {
        console.error('Error loading friends:', error);
    }
}

function createFriendItem(friend, type) {
    const friendItem = document.createElement('div');
    friendItem.className = 'friend-item';
    
    const avatar = document.createElement('div');
    avatar.className = 'friend-avatar';
    
    if (friend.profile_picture) {
        avatar.style.backgroundImage = `url(${friend.profile_picture})`;
        avatar.style.backgroundSize = 'cover';
    } else {
        avatar.textContent = friend.username.charAt(0).toUpperCase();
    }
    
    const info = document.createElement('div');
    info.className = 'friend-info';
    
    const name = document.createElement('div');
    name.className = 'friend-name';
    name.textContent = friend.username;
    
    const status = document.createElement('div');
    status.className = `friend-status status-${friend.status || 'offline'}`;
    status.textContent = friend.status === 'online' ? 'Online' : 
                         friend.last_seen ? `Last seen ${new Date(friend.last_seen).toLocaleTimeString()}` : 
                         'Offline';
    
    info.appendChild(name);
    info.appendChild(status);
    
    friendItem.appendChild(avatar);
    friendItem.appendChild(info);
    
    if (type === 'pending') {
        const actions = document.createElement('div');
        actions.className = 'friend-actions';
        
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'friend-btn btn-accept';
        acceptBtn.textContent = 'Accept';
        acceptBtn.addEventListener('click', () => acceptFriendRequest(friend.username));
        
        const declineBtn = document.createElement('button');
        declineBtn.className = 'friend-btn btn-decline';
        declineBtn.textContent = 'Decline';
        declineBtn.addEventListener('click', () => declineFriendRequest(friend.username));
        
        actions.appendChild(acceptBtn);
        actions.appendChild(declineBtn);
        
        friendItem.appendChild(actions);
    }
    
    return friendItem;
}

async function acceptFriendRequest(friendUsername) {
    try {
        const response = await fetch('/accept_friend_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receiver: currentUser.username,
                sender: friendUsername
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadFriends();
        } else {
            console.error('Error accepting friend request:', data.message);
        }
    } catch (error) {
        console.error('Error accepting friend request:', error);
    }
}

async function declineFriendRequest(friendUsername) {
    try {
        const response = await fetch('/decline_friend_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receiver: currentUser.username,
                sender: friendUsername
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadFriends();
        } else {
            console.error('Error declining friend request:', data.message);
        }
    } catch (error) {
        console.error('Error declining friend request:', error);
    }
}

function showAddFriendModal() {
    document.getElementById('addFriendModal').style.display = 'flex';
    document.getElementById('friendUsernameInput').focus();
}

function hideAddFriendModal() {
    document.getElementById('addFriendModal').style.display = 'none';
    document.getElementById('friendUsernameInput').value = '';
    document.getElementById('friendRequestMessage').textContent = '';
}

async function sendFriendRequest() {
    const friendUsername = document.getElementById('friendUsernameInput').value.trim();
    const messageEl = document.getElementById('friendRequestMessage');
    
    if (!friendUsername) {
        showMessage(messageEl, 'Please enter a username', 'error');
        return;
    }
    
    if (friendUsername.toLowerCase() === currentUser.username.toLowerCase()) {
        showMessage(messageEl, 'You cannot add yourself as a friend', 'error');
        return;
    }
    
    try {
        const response = await fetch('/send_friend_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sender: currentUser.username,
                receiver: friendUsername
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(messageEl, data.message, 'success');
            setTimeout(() => {
                hideAddFriendModal();
                loadFriends();
            }, 1500);
        } else {
            showMessage(messageEl, data.message, 'error');
        }
    } catch (error) {
        showMessage(messageEl, 'Connection error. Please try again.', 'error');
    }
}

function updateFriendStatus(username, status) {
    const friendItems = document.querySelectorAll('.friend-item');
    
    friendItems.forEach(item => {
        const nameElement = item.querySelector('.friend-name');
        if (nameElement && nameElement.textContent === username) {
            const statusElement = item.querySelector('.friend-status');
            if (statusElement) {
                statusElement.className = `friend-status status-${status}`;
                statusElement.textContent = status === 'online' ? 'Online' : 
                                           status === 'offline' ? 'Offline' : 
                                           status;
            }
        }
    });
}

async function loadNotifications() {
    try {
        const response = await fetch(`/get_notifications?username=${currentUser.username}&limit=50`);
        const data = await response.json();
        
        if (data.success) {
            notifications = data.notifications;
            updateNotificationPanel();
            
            // Show badge if there are unread notifications
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                showNotificationBadge(unreadCount);
            }
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function updateNotificationPanel() {
    const notificationList = document.getElementById('notificationList');
    notificationList.innerHTML = '';
    
    if (notifications.length === 0) {
        notificationList.innerHTML = '<div class="notification-item">No notifications</div>';
        return;
    }
    
    notifications.forEach(notification => {
        const notificationItem = document.createElement('div');
        notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
        notificationItem.addEventListener('click', () => markNotificationRead(notification._id));
        
        const title = document.createElement('div');
        title.className = 'notification-title';
        title.textContent = notification.title;
        
        const message = document.createElement('div');
        message.className = 'notification-message';
        message.textContent = notification.message;
        
        const time = document.createElement('div');
        time.className = 'notification-time';
        time.textContent = new Date(notification.created_at).toLocaleString();
        
        notificationItem.appendChild(title);
        notificationItem.appendChild(message);
        notificationItem.appendChild(time);
        
        notificationList.appendChild(notificationItem);
    });
}

function toggleNotificationPanel() {
    const panel = document.getElementById('notificationPanel');
    if (panel.style.display === 'block') {
        panel.style.display = 'none';
    } else {
        panel.style.display = 'block';
        loadNotifications();
    }
}

function hideNotificationPanel() {
    document.getElementById('notificationPanel').style.display = 'none';
}

function showNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    badge.textContent = count || notifications.filter(n => !n.read).length;
    badge.style.display = 'block';
}

function hideNotificationBadge() {
    document.getElementById('notificationBadge').style.display = 'none';
}

async function markNotificationRead(notificationId) {
    try {
        const response = await fetch('/mark_notification_read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: currentUser.username,
                notification_id: notificationId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadNotifications();
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

async function markAllNotificationsRead() {
    try {
        const response = await fetch('/mark_all_notifications_read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: currentUser.username
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadNotifications();
            hideNotificationBadge();
        }
    } catch (error) {
        console.error('Error marking all notifications as read:', error);
    }
}

function showSettings() {
    document.getElementById('app').style.display = 'none';
    document.getElementById('settingsScreen').style.display = 'block';
}

function showApp() {
    document.getElementById('settingsScreen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
}

async function saveSettings() {
    const newSettings = {
        theme: document.getElementById('themeSelect').value,
        failsafe_key: document.getElementById('failsafeKeyInput').value,
        failsafe_url: document.getElementById('failsafeUrlInput').value,
        notifications: document.getElementById('notificationsToggle').classList.contains('active'),
        message_notifications: document.getElementById('messageNotificationsToggle').classList.contains('active'),
        friend_request_notifications: document.getElementById('friendRequestNotificationsToggle').classList.contains('active'),
        sound_notifications: document.getElementById('soundNotificationsToggle').classList.contains('active')
    };
    
    try {
        const response = await fetch('/update_settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: currentUser.username,
                settings: newSettings
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            settings = newSettings;
            applySettings();
            showApp();
        }
    } catch (error) {
        console.error('Error saving settings:', error);
    }
}

async function saveProfilePicture() {
    const profilePicture = document.getElementById('profilePictureInput').value.trim();
    
    if (!profilePicture) {
        alert('Please enter a Base64 encoded image');
        return;
    }
    
    try {
        const response = await fetch('/update_profile_picture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: currentUser.username,
                profile_picture: profilePicture
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentUser.profile_picture = profilePicture;
            saveToStorage();
            loadUserData();
            alert('Profile picture updated successfully');
        } else {
            alert('Error updating profile picture: ' + data.message);
        }
    } catch (error) {
        console.error('Error updating profile picture:', error);
        alert('Error updating profile picture');
    }
}

function handleFailsafeKey(e) {
    if (!settings.failsafe_key) return;
    
    const keyCombination = settings.failsafe_key.toLowerCase();
    const pressedKey = [];
    
    if (e.ctrlKey) pressedKey.push('ctrl');
    if (e.altKey) pressedKey.push('alt');
    if (e.shiftKey) pressedKey.push('shift');
    pressedKey.push(e.key.toLowerCase());
    
    const pressedKeyStr = pressedKey.join('+');
    
    if (pressedKeyStr === keyCombination) {
        window.location.href = settings.failsafe_url || 'https://www.google.com';
    }
}

function logout() {
    if (socket) {
        socket.disconnect();
    }
    
    currentUser = null;
    localStorage.removeItem('currentUser');
    
    document.getElementById('app').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginMessage').textContent = '';
}

function saveToStorage() {
    if (currentUser) {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }
}

function loadFromStorage() {
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        initializeApp();
    }
}

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    loadFromStorage();
});
